local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local checkpoints = {}
local currentIndex = 1
local autoRepeat = false
local repeatDelay = 3
local lastTeleportTime = 0

-- GUI chính
local gui = Instance.new("ScreenGui", LocalPlayer:WaitForChild("PlayerGui"))
gui.Name = "CheckpointGui"
gui.ResetOnSpawn = false

-- Nút hiện/ẩn GUI
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 120, 0, 35)
toggleButton.Position = UDim2.new(0, 10, 0.4, 0)
toggleButton.BackgroundColor3 = Color3.fromRGB(100, 150, 250)
toggleButton.Text = "Ẩn/Hiện Checkpoint"
toggleButton.Font = Enum.Font.SourceSansBold
toggleButton.TextColor3 = Color3.new(1,1,1)
toggleButton.TextSize = 14
toggleButton.Draggable = true
toggleButton.Parent = gui

-- Frame chính
local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 350, 0, 400)
frame.Position = UDim2.new(0, 140, 0.3, 0)
frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true

-- Tiêu đề
local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, 0, 0, 30)
title.Text = "📍 Checkpoint Teleport"
title.BackgroundTransparency = 1
title.Font = Enum.Font.SourceSansBold
title.TextSize = 20
title.TextColor3 = Color3.new(1,1,1)

-- Danh sách checkpoint
local list = Instance.new("ScrollingFrame", frame)
list.Size = UDim2.new(1, -20, 0, 260)
list.Position = UDim2.new(0, 10, 0, 40)
list.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
list.BorderSizePixel = 0
list.ScrollBarThickness = 6
list.CanvasSize = UDim2.new(0, 0, 0, 0)

local layout = Instance.new("UIListLayout", list)
layout.Padding = UDim.new(0, 5)

-- Nút thêm checkpoint
local addButton = Instance.new("TextButton", frame)
addButton.Size = UDim2.new(0.5, -15, 0, 35)
addButton.Position = UDim2.new(0, 10, 1, -90)
addButton.Text = "➕ Lưu Checkpoint"
addButton.Font = Enum.Font.SourceSansBold
addButton.TextSize = 16
addButton.BackgroundColor3 = Color3.fromRGB(80, 180, 80)
addButton.TextColor3 = Color3.new(1,1,1)

-- Nút bật tắt lặp lại
local repeatButton = Instance.new("TextButton", frame)
repeatButton.Size = UDim2.new(0.5, -15, 0, 35)
repeatButton.Position = UDim2.new(0.5, 5, 1, -90)
repeatButton.Text = "Bật Lặp lại"
repeatButton.Font = Enum.Font.SourceSansBold
repeatButton.TextSize = 16
repeatButton.BackgroundColor3 = Color3.fromRGB(100, 150, 250)
repeatButton.TextColor3 = Color3.new(1,1,1)

-- Nhập thời gian delay
local delayBox = Instance.new("TextBox", frame)
delayBox.Size = UDim2.new(1, -20, 0, 30)
delayBox.Position = UDim2.new(0, 10, 1, -50)
delayBox.PlaceholderText = "Thời gian lặp (s)"
delayBox.Text = tostring(repeatDelay)
delayBox.Font = Enum.Font.SourceSans
delayBox.TextSize = 16
delayBox.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
delayBox.TextColor3 = Color3.new(1, 1, 1)

-- Nút đóng GUI
local closeButton = Instance.new("TextButton", frame)
closeButton.Size = UDim2.new(1, -20, 0, 30)
closeButton.Position = UDim2.new(0, 10, 1, -15)
closeButton.Text = "❌ Đóng GUI"
closeButton.Font = Enum.Font.SourceSansBold
closeButton.TextSize = 16
closeButton.BackgroundColor3 = Color3.fromRGB(180, 50, 50)
closeButton.TextColor3 = Color3.new(1, 1, 1)

-- Tạo bảng danh sách
local function updateCheckpointList()
    for _, child in pairs(list:GetChildren()) do
        if child:IsA("Frame") then child:Destroy() end
    end

    for i, cp in ipairs(checkpoints) do
        local row = Instance.new("Frame")
        row.Size = UDim2.new(1, 0, 0, 35)
        row.BackgroundColor3 = cp.Locked and Color3.fromRGB(100, 100, 100) or Color3.fromRGB(50, 50, 50)
        row.Parent = list

        local label = Instance.new("TextLabel", row)
        label.Size = UDim2.new(0.4, 0, 1, 0)
        label.Text = cp.Name
        label.Font = Enum.Font.SourceSans
        label.TextSize = 14
        label.TextColor3 = Color3.new(1, 1, 1)
        label.BackgroundTransparency = 1
        label.TextXAlignment = Enum.TextXAlignment.Left

        local tp = Instance.new("TextButton", row)
        tp.Size = UDim2.new(0.2, 0, 1, 0)
        tp.Position = UDim2.new(0.4, 0, 0, 0)
        tp.Text = "TP"
        tp.Font = Enum.Font.SourceSansBold
        tp.BackgroundColor3 = Color3.fromRGB(100, 200, 100)
        tp.TextColor3 = Color3.new(1, 1, 1)
        tp.TextSize = 14
        tp.MouseButton1Click:Connect(function()
            if not cp.Locked and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                LocalPlayer.Character.HumanoidRootPart.CFrame = cp.CFrame * CFrame.new(0, 3, 0)
            end
        end)

        local lock = Instance.new("TextButton", row)
        lock.Size = UDim2.new(0.2, 0, 1, 0)
        lock.Position = UDim2.new(0.6, 0, 0, 0)
        lock.Text = cp.Locked and "🔒" or "🔓"
        lock.Font = Enum.Font.SourceSansBold
        lock.BackgroundColor3 = Color3.fromRGB(200, 150, 50)
        lock.TextColor3 = Color3.new(1, 1, 1)
        lock.TextSize = 14
        lock.MouseButton1Click:Connect(function()
            cp.Locked = not cp.Locked
            updateCheckpointList()
        end)

        local del = Instance.new("TextButton", row)
        del.Size = UDim2.new(0.2, 0, 1, 0)
        del.Position = UDim2.new(0.8, 0, 0, 0)
        del.Text = "❌"
        del.Font = Enum.Font.SourceSansBold
        del.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
        del.TextColor3 = Color3.new(1, 1, 1)
        del.TextSize = 14
        del.MouseButton1Click:Connect(function()
            table.remove(checkpoints, i)
            updateCheckpointList()
        end)
    end

    list.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 10)
end

-- Nút thêm checkpoint
addButton.MouseButton1Click:Connect(function()
    local character = LocalPlayer.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        -- Tạo GUI đặt tên
        local inputGui = Instance.new("ScreenGui", gui)
        local inputFrame = Instance.new("Frame", inputGui)
        inputFrame.Size = UDim2.new(0, 250, 0, 120)
        inputFrame.Position = UDim2.new(0.5, -125, 0.5, -60)
        inputFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        inputFrame.BorderSizePixel = 0

        local inputBox = Instance.new("TextBox", inputFrame)
        inputBox.Size = UDim2.new(1, -20, 0, 40)
        inputBox.Position = UDim2.new(0, 10, 0, 10)
        inputBox.PlaceholderText = "Tên checkpoint"
        inputBox.Font = Enum.Font.SourceSans
        inputBox.TextSize = 16
        inputBox.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
        inputBox.TextColor3 = Color3.new(1, 1, 1)

        local okButton = Instance.new("TextButton", inputFrame)
        okButton.Size = UDim2.new(1, -20, 0, 40)
        okButton.Position = UDim2.new(0, 10, 0, 65)
        okButton.Text = "OK"
        okButton.BackgroundColor3 = Color3.fromRGB(80, 180, 80)
        okButton.TextColor3 = Color3.new(1, 1, 1)
        okButton.Font = Enum.Font.SourceSansBold
        okButton.TextSize = 18

        okButton.MouseButton1Click:Connect(function()
            local name = inputBox.Text ~= "" and inputBox.Text or ("Checkpoint #" .. (#checkpoints + 1))
            table.insert(checkpoints, {
                CFrame = character.HumanoidRootPart.CFrame,
                Name = name,
                Locked = false
            })
            inputGui:Destroy()
            updateCheckpointList()
        end)
    end
end)

-- Nút bật/tắt lặp lại
repeatButton.MouseButton1Click:Connect(function()
    autoRepeat = not autoRepeat
    repeatButton.Text = autoRepeat and "Tắt Lặp lại" or "Bật Lặp lại"
    repeatButton.BackgroundColor3 = autoRepeat and Color3.fromRGB(250, 150, 100) or Color3.fromRGB(100, 150, 250)
end)

-- Thay đổi thời gian delay
delayBox.FocusLost:Connect(function()
    local value = tonumber(delayBox.Text)
    if value and value > 0 then
        repeatDelay = value
    else
        delayBox.Text = tostring(repeatDelay)
    end
end)

-- Nút đóng GUI
closeButton.MouseButton1Click:Connect(function()
    gui:Destroy()
end)

-- Nút ẩn hiện GUI chính
toggleButton.MouseButton1Click:Connect(function()
    frame.Visible = not frame.Visible
end)

-- Tự động dịch chuyển
RunService.RenderStepped:Connect(function()
    if autoRepeat and #checkpoints > 0 then
        local now = tick()
        if now - lastTeleportTime >= repeatDelay then
            local target = checkpoints[currentIndex]
            if target and not target.Locked then
                local character = LocalPlayer.Character
                if character and character:FindFirstChild("HumanoidRootPart") then
                    character.HumanoidRootPart.CFrame = target.CFrame * CFrame.new(0, 3, 0)
                    print("TP đến:", target.Name)
                end
                lastTeleportTime = now
            end
            currentIndex = (currentIndex % #checkpoints) + 1
        end
    end
end)
